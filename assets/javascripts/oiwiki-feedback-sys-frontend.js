(function(_,w){typeof exports=="object"&&typeof module<"u"?w(exports):typeof define=="function"&&define.amd?define(["exports"],w):(_=typeof globalThis<"u"?globalThis:_||self,w(_.OIWikiFeedbackSysFrontend={}))})(this,function(_){"use strict";const w=function(t,e){return t.reduce((s,a)=>((s[e(a)]=s[e(a)]||[]).push(a),s),{})},V=new Intl.DateTimeFormat(void 0,{dateStyle:"short",timeStyle:"short"});let D=!1,b="/api",n=null,r,C,h,L;const B=async()=>{const t=await fetch(`${b}meta/github-app`,{method:"GET"});if(!t.ok)throw t;L||(L=(await t.json()).data)},U=()=>{const t=new URL(window.location.href),e=t.searchParams.get("oauth_token");e&&(document.cookie=`oauth_token=${e}; path=/; expires=${new Date(JSON.parse(atob(e.split(".")[1])).exp*1e3).toUTCString()}; secure`,window.history.replaceState(null,"",t.pathname))},M=()=>document.cookie.replace(/(?:(?:^|.*;\s*)oauth_token\s*\=\s*([^;]*).*$)|^.*$/,"$1"),H=()=>{const t=M();if(!t)return;const e=atob(t.split(".")[1]);return JSON.parse(e)},k=({id:t,content:e,actions:s=new Map,parent:a=document.body,insertPosition:l="afterend",tag:o="div",initialize:u=()=>{}})=>{let i=document.querySelector(`#${t}`);if(i)return i;a.insertAdjacentHTML(l,`
    <${o} id="${t}">
      ${e.trim()}
    </${o}>
    `.trim()),i=document.querySelector(`#${t}`),u(i);const f=i.querySelectorAll("[data-action]");for(const S of f)S.addEventListener("click",q=>{var x;q.stopPropagation();const y=q.currentTarget,$=y.dataset.action??"";(x=s.get($))==null||x(y)});return i},z=({el:t,focusReply:e=!1})=>{n!==t&&(n==null||n.classList.remove("review_selected"),n=t),((n==null?void 0:n.classList.contains("review_has_comments"))===!0||e)&&(n.classList.remove("review_focused"),n.classList.add("review_selected"),T())},N=()=>{n==null||n.classList.remove("review_selected"),n=null},F=({el:t})=>{k({id:"review-context-menu",content:`
    <button data-action="comment">
      <!-- <iconify-icon class="iconify-inline" icon="material-symbols:add-comment-outline-rounded"></iconify-icon> -->
      <svg class="iconify-icon iconify-inline" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M11 11v2q0 .425.288.713T12 14t.713-.288T13 13v-2h2q.425 0 .713-.288T16 10t-.288-.712T15 9h-2V7q0-.425-.288-.712T12 6t-.712.288T11 7v2H9q-.425 0-.712.288T8 10t.288.713T9 11zm-5 7l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"></path></svg>
      <span>评论该段</span>
    </button>
    `,parent:t,insertPosition:"beforeend",actions:new Map([["comment",e=>{e.remove(),z({el:t,focusReply:!0})}]]),initialize:e=>{e.addEventListener("mouseenter",()=>{t.classList.add("review_focused")}),e.addEventListener("mouseleave",()=>{t.classList.remove("review_focused")})}})},J=()=>{document.querySelector("#review-context-menu").remove()},T=async()=>{const t=[...await P()],e=n;e&&t.find(a=>a.offset.start===parseInt(e.dataset.originalDocumentStart)&&a.offset.end===parseInt(e.dataset.originalDocumentEnd))===void 0&&t.push({id:-1,offset:{start:parseInt(e.dataset.originalDocumentStart),end:parseInt(e.dataset.originalDocumentEnd)},commenter:{name:"新评论"},comment:"",created_time:new Date().toISOString(),pending:!0}),G(t);let s=document.querySelector(`#review-comments-panel .comments_group[data-original-document-start="${n==null?void 0:n.dataset.originalDocumentStart}"][data-original-document-end="${n==null?void 0:n.dataset.originalDocumentEnd}"]`);s==null||s.classList.add("review_selected"),s==null||s.scrollIntoView({behavior:"smooth",block:"start"}),C.classList.add("review_hidden"),h.classList.remove("review_hidden")},E=()=>{h.classList.add("review_hidden"),C.classList.remove("review_hidden")},W=async({offsets:t,content:e})=>{var i;const s=sessionStorage.getItem("commitHash");if(!s)throw new Error("找不到 Commit hash，请联系站点管理员");const a={offset:{start:t[0],end:t[1]},comment:e},l=fetch(`${b}comment/${encodeURIComponent(new URL(window.location.href).pathname)}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${M()}`},body:JSON.stringify({...a,commit_hash:s})}),o=(r==null?void 0:r.length)??-1;r&&r.push({...a,commenter:{name:((i=H())==null?void 0:i.name)??"未知用户"},id:r.length,created_time:new Date().toISOString(),pending:!0});const u=await l;if(!u.ok)throw r&&(r=r.filter(f=>f.id!==o)),u;r&&(r=r.map(f=>f.id===o?{...f,pending:!1}:f)),j()},P=async()=>{if(r)return r;const t=await fetch(`${b}comment/${encodeURIComponent(new URL(window.location.href).pathname)}`);if(!t.ok)throw t;const e=(await t.json()).data;return r=e,e},G=t=>{const e=h.querySelector(".panel_main"),s=document.createDocumentFragment(),a=w(t,l=>`${l.offset.start}-${l.offset.end}`);for(const l of Object.keys(a).sort((o,u)=>parseInt(o.split("-")[0])-parseInt(u.split("-")[0]))){const o=document.createElement("div");o.classList.add("comments_group");const u=l.split("-");o.dataset.originalDocumentStart=u[0],o.dataset.originalDocumentEnd=u[1];const i=document.querySelector(`.review_enabled[data-original-document-start="${o.dataset.originalDocumentStart}"][data-original-document-end="${o.dataset.originalDocumentEnd}"]`),f=(i==null?void 0:i.textContent)??"";o.innerHTML=`
      <div class="comments_group_header">
        <span class="comments_group_text_content">${f}</span>
      </div>
      <div class="comments_group_main"></div>
      <div class="comments_group_footer">
        <div class="comment_reply_panel">
          <div class="comment_username"></div>
          <textarea required placeholder="写下你的评论..."  autocapitalize="sentences" autocomplete="on" spellcheck="true" autofocus="true" maxlength="65535"></textarea>
          <div class="comment_actions comment_actions_login">
            <button class="comment_reply_item comment_reply_item_primary" data-action="login">登录到 GitHub</button>
          </div>
          <div class="comment_actions comment_actions_reply">
            <span class="comment_reply_notification"></span>
            <button class="comment_reply_item" data-action="cancel">取消</button>
            <button class="comment_reply_item comment_reply_item_primary" data-action="submit">提交</button>
          </div>
        </div>
      </div>
    `.trim(),o.querySelector(".comment_reply_panel textarea").addEventListener("input",m=>{const c=m.currentTarget;c.style.height="5px",c.style.height=c.scrollHeight+"px"});const S=o.querySelector(".comment_username"),q=o.querySelector(".comment_actions_login"),y=H();y?(S.textContent=`作为 ${y.name} 发表评论`,q.style.display="none"):S.textContent="登录到 GitHub 以发表评论";for(const m of o.querySelectorAll(".comment_actions"))m.addEventListener("click",c=>{if(!(c.target instanceof HTMLButtonElement))return;const I=c.target,v=o.querySelector(".comment_reply_panel textarea"),p=o.querySelector(".comment_reply_notification"),R=o.querySelector(".comment_reply_item[data-action='submit']");switch(I==null?void 0:I.dataset.action){case"login":if(!L){console.log("githubMeta not ready");return}window.location.href=`https://github.com/login/oauth/authorize?client_id=${L.client_id}&state=${encodeURIComponent(JSON.stringify({redirect:window.location.href}))}`;break;case"cancel":v.disabled=!1,v.value="",p.textContent="",R.disabled=!1;break;case"submit":if(v.disabled=!0,R.disabled=!0,!v.checkValidity()){p.textContent="请填写评论内容";return}p.textContent="",W({offsets:[parseInt(n.dataset.originalDocumentStart),parseInt(n.dataset.originalDocumentEnd)],content:v.value}).then(()=>{v.value="",p.textContent=""}).catch(async d=>{var g;if(console.error(d),d instanceof Error)p.textContent=d.message;else if(d instanceof Response)if(((g=d.headers.get("content-type"))==null?void 0:g.includes("application/json"))===!0){const K=await d.json();p.textContent=K.error}else p.textContent=`未知接口错误：${d.status}(${d.statusText})`;else p.textContent="提交失败，请稍后再试"}).finally(()=>{T().then(()=>{const d=h.querySelector(".review_selected .comment_reply_notification"),g=h.querySelector(".review_selected .comment_reply_panel textarea");d&&(d.textContent=p.textContent),g&&(g.value=v.value)})}),T();break}});o.addEventListener("mouseenter",()=>{i==null||i.classList.add("review_focused")}),o.addEventListener("mouseleave",()=>{i==null||i.classList.remove("review_focused")}),o.addEventListener("click",m=>{var c;m.stopPropagation(),n==null||n.classList.remove("review_selected"),i==null||i.classList.remove("review_focused"),i==null||i.classList.add("review_selected"),(c=document.querySelector(".comments_group.review_selected"))==null||c.classList.remove("review_selected"),o.classList.add("review_selected"),n=i,n==null||n.scrollIntoView({behavior:"smooth",block:"center"})});const $=a[l].sort((m,c)=>new Date(m.created_time).getTime()-new Date(c.created_time).getTime()),x=o.querySelector(".comments_group_main");for(const m of $){const c=document.createElement("div");c.classList.add("comment"),m.pending&&c.classList.add("comment_pending"),c.innerHTML=`
        <div class="comment_header">
          <span class="comment_commenter"></span>
          <span class="comment_time">${V.format(new Date(m.created_time))}</span>
        </div>
        <div class="comment_main"></div>
      `.trim(),c.querySelector(".comment_commenter").textContent=m.commenter.name,c.querySelector(".comment_main").textContent=m.comment,x.appendChild(c)}s.appendChild(o)}for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(s)},j=async()=>{const t=Array.from(document.querySelectorAll(".review_enabled[data-original-document-start][data-original-document-end]"));await P();for(let e of t)e.classList.remove("review_has_comments"),r.find(s=>s.offset.start===parseInt(e.dataset.originalDocumentStart)&&s.offset.end===parseInt(e.dataset.originalDocumentEnd))&&e.classList.add("review_has_comments")},A="0.3.1";function O(t,{apiEndpoint:e="/api"}={}){b=e.endsWith("/")?e:e+"/",U();const s=Array.from(t.querySelectorAll("[data-original-document-start][data-original-document-end]"));if(!s){console.warn("oiwiki-feedback-sys-frontend not found any offsets to inject, quitting...");return}for(let a of s)a.classList.add("review_enabled"),a.addEventListener("click",l=>{l.stopPropagation(),z({el:l.currentTarget})}),a.addEventListener("mouseenter",l=>{F({el:l.currentTarget})}),a.addEventListener("mouseleave",()=>{J()});if(r=void 0,j(),B(),D){E(),console.log("oiwiki-feedback-sys-frontend has been successfully reset.");return}document.addEventListener("click",()=>{N()}),C=k({id:"review-comments-button",content:`
    <button data-action="open">
      <!-- <iconify-icon class="iconify-inline" icon="material-symbols:comment-outline-rounded"></iconify-icon> -->
      <svg class="iconify-icon iconify-inline" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M7 14h10q.425 0 .713-.288T18 13t-.288-.712T17 12H7q-.425 0-.712.288T6 13t.288.713T7 14m0-3h10q.425 0 .713-.288T18 10t-.288-.712T17 9H7q-.425 0-.712.288T6 10t.288.713T7 11m0-3h10q.425 0 .713-.288T18 7t-.288-.712T17 6H7q-.425 0-.712.288T6 7t.288.713T7 8M4 18q-.825 0-1.412-.587T2 16V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v15.575q0 .675-.612.938T20.3 20.3L18 18zm14.85-2L20 17.125V4H4v12zM4 16V4z"></path></svg>
    </button>
    `,actions:new Map([["open",()=>T()]])}),h=k({id:"review-comments-panel",content:`
    <div class="panel_header">
      <span>本页评论</span>
      <button data-action="close">
        <!-- <iconify-icon class="iconify-inline" icon="material-symbols:close"></iconify-icon> -->
        <svg class="iconify-icon iconify-inline" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z"></path></svg>
      </button>
    </div>
    <div class="panel_main"></div>
    `,insertPosition:"beforeend",actions:new Map([["close",()=>E()]])}),E(),console.log(`oiwiki-feedback-sys-frontend version ${A} has been successfully installed.`),D=!0}_.__VERSION__=A,_.setupReview=O,Object.defineProperty(_,Symbol.toStringTag,{value:"Module"})});
